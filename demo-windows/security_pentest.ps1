# Security Penetration Testing Script for Windows
# Simplified security test script for Docker containers and APIs

# Configuration
$ErrorActionPreference = "Continue"
$CONTAINER_NAME = "demo-llm_service-1"
$API_HOST = "localhost"
$API_PORT = "7871"
$DATA_PORT = "8000"
$TIMESTAMP = Get-Date -Format "yyyyMMdd_HHmmss"
$REPORT_DIR = "security_reports_$TIMESTAMP"

# Color output functions
function Write-Info { 
    param([string]$Message)
    Write-Host "[INFO] $Message" -ForegroundColor Yellow 
}

function Write-Success { 
    param([string]$Message)
    Write-Host "[SUCCESS] $Message" -ForegroundColor Green 
}

function Write-Error { 
    param([string]$Message)
    Write-Host "[ERROR] $Message" -ForegroundColor Red 
}

# Create report directory
New-Item -ItemType Directory -Force -Path $REPORT_DIR | Out-Null
Write-Info "Created report directory: $REPORT_DIR"

Write-Info "Starting security tests..."
Write-Host "========================================" -ForegroundColor Cyan

# Test 1: Container Vulnerability Scan
Write-Info "Test 1: Container vulnerability scan with Trivy..."
try {
    docker run --rm -v /var/run/docker.sock:/var/run/docker.sock `
        aquasec/trivy:latest image `
        --severity HIGH,CRITICAL `
        $CONTAINER_NAME 2>&1 | Out-File "$REPORT_DIR\vulnerabilities.txt"
    
    if (Test-Path "$REPORT_DIR\vulnerabilities.txt") {
        Write-Success "Vulnerability scan completed"
    }
} catch {
    Write-Error "Trivy scan failed: $_"
}

Write-Host ""

# Test 2: API Security Scan
Write-Info "Test 2: API security scan with OWASP ZAP..."
try {
    # Test LLM Service
    docker run --rm -v "${PWD}/${REPORT_DIR}:/zap/wrk" `
        owasp/zap2docker-stable zap-baseline.py `
        -t "http://host.docker.internal:$API_PORT" `
        -r "llm_api_security.html" 2>&1 | Out-Null
    
    # Test Data Service
    docker run --rm -v "${PWD}/${REPORT_DIR}:/zap/wrk" `
        owasp/zap2docker-stable zap-baseline.py `
        -t "http://host.docker.internal:$DATA_PORT" `
        -r "data_api_security.html" 2>&1 | Out-Null
    
    Write-Success "API security scans completed"
} catch {
    Write-Error "ZAP scan failed: $_"
}

Write-Host ""

# Test 3: Docker Security Benchmark
Write-Info "Test 3: Docker security benchmark..."
try {
    docker run --rm --net host --pid host `
        -v /var/run/docker.sock:/var/run/docker.sock:ro `
        docker/docker-bench-security 2>&1 | Out-File "$REPORT_DIR\docker_bench.txt"
    
    if (Test-Path "$REPORT_DIR\docker_bench.txt") {
        Write-Success "Docker benchmark completed"
    }
} catch {
    Write-Error "Docker benchmark failed: $_"
}

Write-Host ""

# Test 4: Network Security
Write-Info "Test 4: Network security check..."
try {
    $NetworkTest = @{
        Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        LLM_Port = $API_PORT
        Data_Port = $DATA_PORT
        Tests = @()
    }
    
    # Test LLM Service connectivity
    try {
        $response = Invoke-WebRequest -Uri "http://${API_HOST}:${API_PORT}/health" -TimeoutSec 5
        $NetworkTest.Tests += @{
            Service = "LLM Service"
            Port = $API_PORT
            Status = "Accessible"
            Response = $response.StatusCode
        }
    } catch {
        $NetworkTest.Tests += @{
            Service = "LLM Service"
            Port = $API_PORT
            Status = "Failed"
            Error = $_.Exception.Message
        }
    }
    
    # Test Data Service connectivity
    try {
        $response = Invoke-WebRequest -Uri "http://${API_HOST}:${DATA_PORT}/health" -TimeoutSec 5
        $NetworkTest.Tests += @{
            Service = "Data Service"
            Port = $DATA_PORT
            Status = "Accessible"
            Response = $response.StatusCode
        }
    } catch {
        $NetworkTest.Tests += @{
            Service = "Data Service"
            Port = $DATA_PORT
            Status = "Failed"
            Error = $_.Exception.Message
        }
    }
    
    $NetworkTest | ConvertTo-Json -Depth 3 | Out-File "$REPORT_DIR\network_security.json"
    Write-Success "Network security check completed"
} catch {
    Write-Error "Network security check failed: $_"
}

Write-Host ""

# Test 5: Container Configuration Check
Write-Info "Test 5: Container configuration check..."
try {
    $containers = docker ps --format "{{.Names}}" | Where-Object { $_ -match "demo-" }
    
    $configReport = @()
    foreach ($container in $containers) {
        $inspect = docker inspect $container | ConvertFrom-Json
        $configReport += @{
            Container = $container
            Privileged = $inspect.HostConfig.Privileged
            User = $inspect.Config.User
            ReadOnlyRootfs = $inspect.HostConfig.ReadonlyRootfs
            NetworkMode = $inspect.HostConfig.NetworkMode
            CapAdd = $inspect.HostConfig.CapAdd
            SecurityOpt = $inspect.HostConfig.SecurityOpt
        }
    }
    
    $configReport | ConvertTo-Json -Depth 3 | Out-File "$REPORT_DIR\container_config.json"
    Write-Success "Container configuration check completed"
} catch {
    Write-Error "Container configuration check failed: $_"
}

Write-Host ""
Write-Host "========================================" -ForegroundColor Cyan

# Generate summary report
Write-Info "Generating summary report..."
$summaryReport = @"
Security Test Summary Report
Generated: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
========================================

Report Directory: $REPORT_DIR

Tests Performed:
1. Container Vulnerability Scan (Trivy)
2. API Security Scan (OWASP ZAP)
3. Docker Security Benchmark
4. Network Security Check
5. Container Configuration Check

Review Files:
- vulnerabilities.txt: Container vulnerability scan results
- llm_api_security.html: LLM API security scan results
- data_api_security.html: Data API security scan results
- docker_bench.txt: Docker security benchmark results
- network_security.json: Network security test results
- container_config.json: Container configuration analysis

Recommendations:
1. Review HIGH and CRITICAL vulnerabilities in vulnerabilities.txt
2. Check API security issues in the HTML reports
3. Address any Docker security benchmark failures
4. Ensure proper network isolation
5. Verify container configurations follow security best practices
"@

$summaryReport | Out-File "$REPORT_DIR\SUMMARY.txt"

Write-Host ""
Write-Success "Security tests completed!"
Write-Info "Reports saved in: $REPORT_DIR\"
Write-Host ""
Write-Info "To view the summary:"
Write-Host "  Get-Content $REPORT_DIR\SUMMARY.txt" -ForegroundColor Cyan
Write-Host ""
Write-Info "To open HTML reports in browser:"
Write-Host "  Start-Process $REPORT_DIR\llm_api_security.html" -ForegroundColor Cyan
Write-Host "  Start-Process $REPORT_DIR\data_api_security.html" -ForegroundColor Cyan
