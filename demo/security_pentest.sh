#!/bin/bash

# Simplified security test script
set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_info() { echo -e "${YELLOW}[INFO]${NC} $1"; }
print_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
print_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Configuration
CONTAINER_NAME="fastapi_llm-llm_service"
API_HOST="localhost"
API_PORT="8000"
REPORT_DIR="security_reports_$(date +%Y%m%d_%H%M%S)"

mkdir -p $REPORT_DIR

print_info "Starting security tests..."

# Test 1: Container Security (Docker-based)
print_info "Test 1: Container vulnerability scan..."
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
    aquasec/trivy:latest image \
    --severity HIGH,CRITICAL \
    $CONTAINER_NAME:latest > $REPORT_DIR/vulnerabilities.txt 2>&1 || true

# Test 2: API Security (Docker-based)
print_info "Test 2: API security scan..."
docker run --rm -v $(pwd)/$REPORT_DIR:/zap/wrk:rw \
    owasp/zap2docker-stable zap-baseline.py \
    -t http://host.docker.internal:$API_PORT \
    -r api_security.html || true

# Test 3: Docker Security Benchmark
print_info "Test 3: Docker security benchmark..."
docker run --rm --net host --pid host --userns host --cap-add audit_control \
    -v /var/lib:/var/lib:ro \
    -v /var/run/docker.sock:/var/run/docker.sock:ro \
    -v /usr/lib/systemd:/usr/lib/systemd:ro \
    -v /etc:/etc:ro \
    docker/docker-bench-security > $REPORT_DIR/docker_bench.txt 2>&1 || true

print_success "Security tests completed! Reports saved in: $REPORT_DIR/"